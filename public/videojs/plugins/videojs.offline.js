!function(e,n){"function"==typeof define&&define.amd?define([],n.bind(this,e,e.videojs)):"undefined"!=typeof module&&module.exports?module.exports=n(e,e.videojs):n(e,e.videojs)}(window,function(e,n){"use strict";e.videojs_offline={version:"0.1"};n.registerPlugin("offline",function(e){var i,t=this,o=n.dom,s=t.el(),r=!1,a=n.mergeOptions||n.util.mergeOptions;(e=a({offlineStream:"",offlineImage:"",offlineTimeout:30,offlineCountdown:!1,liveStream:"",clock:0},e||{})).liveStream="";var d=function(e,n){try{return e.querySelector(n)}catch(e){return!1}};var l=document.createElement("div");function f(){var e=d(s,".vjs-error-display");e&&o.addClass(e,"vjs-hidden"),o.addClass(d(s,".vjs-control-bar"),"vjs-hidden"),o.addClass(d(s,".vjs-background-bar"),"vjs-hidden");var n=d(s,".vjs-chromecast-button");n&&o.addClass(n,"vjs-hidden"),t.$(".vjs-tech").style.pointerEvents="none"}function c(){t.poster(e.offlineImage),d(s,".vjs-poster").style.opacity="1";var n=d(s,".vjs-error-display");o.addClass(d(s,".vjs-big-play-button"),"vjs-hidden"),o.addClass(d(s,".vjs-loading-spinner"),"vjs-hidden"),o.addClass(d(s,".vjs-control-bar"),"vjs-hidden"),o.addClass(d(s,".vjs-background-bar"),"vjs-hidden"),n&&o.addClass(n,"vjs-abs-hidden");var i=d(s,".vjs-chromecast-button");i&&o.addClass(i,"vjs-hidden")}function v(e){var n=new XMLHttpRequest;void 0!==e.withCredentials&&(n.withCredentials=!0),n.onload=function(){if(200==this.status)return t.src(e),t.load(),t.play(),t.isOffline=!1,!0;t.isOffline=!0,f(),t.play()},n.onerror=function(){t.isOffline=!0,f(),t.play()},void 0!==e.src?n.open("HEAD",e.src):n.open("HEAD",e),n.send()}function u(){if(""==e.liveStream&&(e.liveStream=t.currentSource()),""!=e.offlineStream)return t.src({src:e.offlineStream,offline:!0}),f(),t.isOffline=!0,o.hasClass(s,"vjs-has-started")?void 0!==(n=t.play())&&n.then(function(){}).catch(function(e){t.muted(!0),t.play()}):t.pause(),t.on("timeupdate",function(){if(t.isOffline&&e.offlineCountdown&&t.currentTime()>0){1!=r&&(s.appendChild(l),r=!0);var n=p(t.duration()-t.currentTime());e.offlineCountdown&&(l.innerHTML=n)}}),t.on("ended",function(){t.isOffline&&v(e.liveStream)}),!0;var n;""!=e.offlineImage&&(t.reset(),c())}function p(e){var n=parseInt(e,10);return[Math.floor(n/3600),Math.floor(n/60)%60,n%60].map(e=>e<10?"0"+e:e).filter((e,n)=>"00"!==e||n>0).join(":")}return l.style.position="absolute",l.style.right="30px",l.style.bottom="25px",l.style.fontSize="20px",l.style.color="#fff",l.style.textShadow="1px 1px 1px #000",t.on("ready",function(){function n(e){var n=new XMLHttpRequest;void 0!==typeof e.withCredentials&&(n.withCredentials=!0),n.onload=function(){if(200==this.status){var n=this.responseText,i=n.indexOf("#EXTM3U"),o=n.indexOf("#EXT-X-STREAM-INF"),s=n.indexOf("#EXTINF"),r=n.indexOf("<MPD xmlns"),d=n.indexOf("<Period");!1!==i&&0==r&&(o>-1||s>-1||d>-1)?(t.reset(),t.src(e),t.load(),t.play(),t.isOffline=!1):a()}else a()},null!=typeof e.src?n.open("GET",e.src):n.open("GET",e),n.send()}function a(){f(),t.src()!==e.offlineStream&&(t.reset(),t.src({src:e.offlineStream,offline:!0})),t.play(),t.isOffline=!0,t.on("timeupdate",function(){if(t.isOffline&&e.offlineCountdown&&t.currentTime()>0){1!=r&&(s.appendChild(l),r=!0);var n=p(t.duration()-t.currentTime());e.offlineCountdown&&(l.innerHTML=n)}}),t.one("ended",function(){n(e.liveStream,e.withCredentials)})}t.on("error",function(){var e=t.error();(e.code>0&&e.code<5||"unknown"===e.code)&&u()}),t.tech(!0).on("retryplaylist",function(){""==e.liveStream&&(e.liveStream=t.currentSource()),""!=e.offlineStream&&n(e.liveStream),""!=e.offlineImage&&(c(),t.src(e.offlineImage),t.load())}),t.on("playing",function(){var e=d(s,".vjs-chromecast-button");if(t.isOffline)e&&o.addClass(e,"vjs-hidden");else{clearTimeout(i),t.$(".vjs-tech").style.pointerEvents="auto",o.removeClass(d(s,".vjs-big-play-button"),"vjs-hidden"),o.removeClass(d(s,".vjs-loading-spinner"),"vjs-hidden"),o.removeClass(d(s,".vjs-control-bar"),"vjs-hidden"),o.removeClass(d(s,".vjs-background-bar"),"vjs-hidden"),e&&o.removeClass(e,"vjs-hidden");try{s.removeChild(l)}catch(e){}d(s,".vjs-poster").style.opacity="0"}})}),this})});